<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ ¡å›­å¢™</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box;font-family:"Microsoft YaHei",sans-serif;}
  body{background:#f5f7fa;color:#222;}
  .container{max-width:700px;margin:0 auto;padding:15px;}

  .nav{
    background:#fff;border-radius:12px;padding:12px 15px;
    display:flex;justify-content:space-between;align-items:center;
    margin-bottom:15px;box-shadow:0 2px 8px rgba(0,0,0,0.05);
  }
  .nav h1{font-size:18px;color:#409eff;}
  .nav .tabs{display:flex;gap:10px;}
  .nav button{
    background:none;border:none;padding:6px 10px;
    border-radius:8px;cursor:pointer;font-size:14px;
  }
  .nav button.active{background:#409eff;color:#fff;}

  .card{
    background:#fff;border-radius:12px;padding:15px;
    margin-bottom:12px;box-shadow:0 2px 6px rgba(0,0,0,0.05);
  }
  .title{font-size:16px;margin-bottom:10px;font-weight:bold;}

  input,textarea{
    width:100%;border:1px solid #ddd;
    border-radius:8px;padding:10px;margin-top:8px;
  }
  textarea{height:100px;resize:none;}
  .btn{
    width:100%;background:#409eff;color:#fff;
    border:none;border-radius:8px;padding:10px;margin-top:10px;cursor:pointer;
  }
  .btn.sm{padding:6px 8px;font-size:12px;width:auto;}
  .btn.danger{background:#f56c6c;}
  .btn.success{background:#67c23a;}
  .btn.warn{background:#ff9800;}
  .link{
    color:#409eff;cursor:pointer;font-size:14px;margin-top:8px;text-align:center;
  }

  .post{
    border-left:3px solid #409eff;padding-left:12px;
    margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid #eee;
  }
  .post .user{font-weight:bold;font-size:14px;margin-bottom:4px;}
  .post .content{font-size:14px;line-height:1.5;margin:6px 0;}
  .post .time{font-size:12px;color:#999;margin-bottom:6px;}

  .page{display:none;}
  .page.active{display:block;}

  .admin-box{display:none;margin-top:15px;border-top:1px solid #ff9800;padding-top:15px;}
  .wait-item{padding:10px;border:1px solid #eee;border-radius:8px;margin-bottom:8px;}
  .info-item{margin:6px 0;font-size:14px;}

  .notice{
    background:#fff3cd;color:#85640d;padding:10px 15px;
    border-radius:8px;margin-bottom:10px;border:1px solid #ffeeba;
  }

  .chat-item{padding:8px 12px;background:#f1f3f5;border-radius:8px;margin-bottom:8px;cursor:pointer;}
  .msg-me{text-align:right;background:#d1e7dd;margin-left:40px;}
  .msg-you{text-align:left;background:#f1f3f5;margin-right:40px;}
  .msg-box{height:300px;overflow-y:auto;padding:10px;border:1px solid #eee;border-radius:8px;margin-bottom:10px;}
</style>
</head>
<body>

<div class="container">
  <div class="nav">
    <h1>ğŸ« æ ¡å›­å¢™</h1>
    <div class="tabs">
      <button onclick="goPage('home')" class="active">é¦–é¡µ</button>
      <button onclick="goPublish()">æˆ‘è¦æŠ•ç¨¿</button>
      <button onclick="goPage('chat')">ç§ä¿¡</button>
      <button onclick="goPage('user')">ä¸ªäººä¸­å¿ƒ</button>
    </div>
  </div>

  <!-- é¦–é¡µ -->
  <div id="home" class="page active">
    <div id="notice" class="notice">åŠ è½½ä¸­...</div>
    <div class="card">
      <div class="title">æ ¡å›­æŠ•ç¨¿</div>
      <div id="postList"></div>
    </div>
  </div>

  <!-- æˆ‘è¦æŠ•ç¨¿ -->
  <div id="publish" class="page">
    <div class="card">
      <div class="title">å‘å¸ƒæŠ•ç¨¿</div>
      <textarea id="content" placeholder="å†™ä¸‹ä½ æƒ³å‘å¸ƒçš„å†…å®¹..."></textarea>
      <button class="btn" onclick="publish()">æäº¤æŠ•ç¨¿ï¼ˆéœ€å®¡æ ¸ï¼‰</button>
    </div>
  </div>

  <!-- ç§ä¿¡ -->
  <div id="chat" class="page">
    <div class="card">
      <div class="title">å…³æ³¨åˆ—è¡¨</div>
      <div id="followList"></div>
    </div>
    <div class="card" id="chatBox" style="display:none;">
      <div class="title" id="chatTo">èŠå¤©</div>
      <div class="msg-box" id="msgBox"></div>
      <input id="msgInput" placeholder="è¾“å…¥æ¶ˆæ¯...">
      <button class="btn" onclick="sendMsg()">å‘é€</button>
    </div>
  </div>

  <!-- ä¸ªäººä¸­å¿ƒ -->
  <div id="user" class="page">
    <div class="card" id="loginCard">
      <div class="title">è´¦å·ç™»å½•</div>
      <input id="login_user" placeholder="ç”¨æˆ·å">
      <input id="login_pwd" type="password" placeholder="å¯†ç ">
      <button class="btn" onclick="login()">ç™»å½•</button>
      <div class="link" onclick="goFindPwd()">å¿˜è®°å¯†ç ï¼Ÿæ‰¾å›å¯†ç </div>
    </div>

    <div class="card" id="findCard" style="display:none;">
      <div class="title">æ‰¾å›å¯†ç </div>
      <input id="find_user" placeholder="ç”¨æˆ·å">
      <input id="find_email" placeholder="æ³¨å†Œæ—¶çš„é‚®ç®±">
      <button class="btn warn" onclick="findPwd()">éªŒè¯å¹¶æ˜¾ç¤ºå¯†ç </button>
      <div class="link" onclick="goLogin()">è¿”å›ç™»å½•</div>
    </div>

    <div class="card" id="regCard">
      <div class="title">æ³¨å†Œè´¦å·ï¼ˆå¿…å¡«é‚€è¯·ç +é‚®ç®±ï¼‰</div>
      <input id="reg_user" placeholder="ç”¨æˆ·åï¼ˆå¿…å¡«ï¼‰">
      <input id="reg_pwd" type="password" placeholder="å¯†ç ï¼ˆå¿…å¡«ï¼‰">
      <input id="reg_wechat" placeholder="å¾®ä¿¡å·">
      <input id="reg_email" placeholder="é‚®ç®±ï¼ˆå¿…å¡«ï¼‰">
      <input id="reg_invite" placeholder="é‚€è¯·ç ï¼ˆå¿…å¡«ï¼‰">
      <button class="btn success" onclick="register()">æ³¨å†Œ</button>
    </div>

    <div class="card" id="userInfo" style="display:none;">
      <div class="title">ä¸ªäººä¿¡æ¯</div>
      <div id="infoDisplay"></div>

      <div style="margin-top:15px;">
        <div class="title">ä¿®æ”¹å¯†ç </div>
        <input id="old_pwd" placeholder="æ—§å¯†ç ">
        <input id="new_pwd" placeholder="æ–°å¯†ç ">
        <button class="btn success" onclick="changePwd()">ç¡®è®¤ä¿®æ”¹</button>
      </div>

      <button class="btn danger" onclick="logout()" style="margin-top:12px;">é€€å‡ºç™»å½•</button>

      <div class="admin-box" id="adminPanel">
        <div class="title">ğŸ”§ ç®¡ç†åå°</div>
        <input id="noticeInput" placeholder="å‘å¸ƒå…¬å‘Š">
        <button class="btn warn" onclick="setNotice()">å‘å¸ƒå…¬å‘Š</button>
        <div class="title" style="margin-top:15px;">å¾…å®¡æ ¸æŠ•ç¨¿</div>
        <div id="waitPosts"></div>
      </div>
    </div>
  </div>
</div>

<script>
// ================= é…ç½® =================
const INVITE_CODE = "123456";
const ADMIN_USER = "admin";

// ================= æ•°æ® =================
function db() {
  return JSON.parse(localStorage.getItem("wall") || `{
    "users":[{"user":"admin","pwd":"admin123","wechat":"admin","email":"admin@qq.com"}],
    "posts":[], "wait":[], "notice":"æ¬¢è¿æ¥åˆ°æ ¡å›­å¢™ï¼",
    "follows":{}, "chats":{}
  }`);
}
function save(d) { localStorage.setItem("wall", JSON.stringify(d)); }

let nowUser = localStorage.getItem("nowUser") || null;
let chatTarget = null;

// ================= é¡µé¢ =================
function goPage(name) {
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
  document.getElementById(name).classList.add("active");
  document.querySelectorAll(".nav button").forEach(b=>b.classList.remove("active"));
  if(event?.target) event.target.classList.add("active");
  if(name==="chat") renderChatList();
}
function goPublish() {
  if(!nowUser){alert("è¯·å…ˆç™»å½•ï¼");goPage("user");return;}
  goPage("publish");
}
function goLogin(){
  document.getElementById("loginCard").style.display="block";
  document.getElementById("findCard").style.display="none";
}
function goFindPwd(){
  document.getElementById("loginCard").style.display="none";
  document.getElementById("findCard").style.display="block";
}

// ================= å…¬å‘Š =================
function showNotice(){
  const d=db();
  document.getElementById("notice").innerText = "ğŸ“¢ " + d.notice;
}
function setNotice(){
  const val=document.getElementById("noticeInput").value.trim();
  if(!val)return;
  const d=db();
  d.notice=val;
  save(d);
  showNotice();
  alert("å…¬å‘Šå‘å¸ƒæˆåŠŸ");
}

// ================= æ³¨å†Œ =================
function register(){
  const user=document.getElementById("reg_user").value.trim();
  const pwd=document.getElementById("reg_pwd").value.trim();
  const wechat=document.getElementById("reg_wechat").value.trim();
  const email=document.getElementById("reg_email").value.trim();
  const code=document.getElementById("reg_invite").value.trim();
  if(!user||!pwd||!email||!code){alert("å¿…å¡«é¡¹ä¸èƒ½ä¸ºç©º");return;}
  if(code!==INVITE_CODE){alert("é‚€è¯·ç é”™è¯¯");return;}
  const d=db();
  if(d.users.find(u=>u.user===user)){alert("ç”¨æˆ·åå·²å­˜åœ¨");return;}
  if(d.users.find(u=>u.email===email)){alert("é‚®ç®±å·²è¢«æ³¨å†Œ");return;}
  d.users.push({user,pwd,wechat,email});
  d.follows[user]=[];
  save(d);
  alert("æ³¨å†ŒæˆåŠŸ");
  goLogin();
}

// ================= ç™»å½• =================
function login(){
  const user=document.getElementById("login_user").value.trim();
  const pwd=document.getElementById("login_pwd").value.trim();
  const d=db();
  const u=d.users.find(x=>x.user===user&&x.pwd===pwd);
  if(!u){alert("è´¦å·æˆ–å¯†ç é”™è¯¯");return;}
  nowUser=user;
  localStorage.setItem("nowUser",user);
  renderUser();
  alert("ç™»å½•æˆåŠŸ");
}

// ================= æ‰¾å›å¯†ç  =================
function findPwd(){
  const user=document.getElementById("find_user").value.trim();
  const email=document.getElementById("find_email").value.trim();
  const d=db();
  const u=d.users.find(x=>x.user===user&&x.email===email);
  if(!u){alert("ä¿¡æ¯ä¸åŒ¹é…");return;}
  alert("ä½ çš„å¯†ç ï¼š"+u.pwd);
  goLogin();
}

// ================= ä¿®æ”¹å¯†ç  =================
function changePwd(){
  const old=document.getElementById("old_pwd").value.trim();
  const newP=document.getElementById("new_pwd").value.trim();
  if(!old||!newP){alert("è¯·å¡«å†™å®Œæ•´");return;}
  const d=db();
  const u=d.users.find(x=>x.user===nowUser);
  if(u.pwd!==old){alert("æ—§å¯†ç é”™è¯¯");return;}
  u.pwd=newP;
  save(d);
  alert("ä¿®æ”¹æˆåŠŸ");
  document.getElementById("old_pwd").value="";
  document.getElementById("new_pwd").value="";
}

// ================= å…³æ³¨ & ç§ä¿¡ =================
function follow(user){
  if(user===nowUser)return;
  const d=db();
  if(!d.follows[nowUser])d.follows[nowUser]=[];
  if(!d.follows[nowUser].includes(user))d.follows[nowUser].push(user);
  save(d);
  alert("å·²å…³æ³¨");
}
function isMutual(user){
  const d=db();
  return d.follows[nowUser]?.includes(user) && d.follows[user]?.includes(nowUser);
}
function renderChatList(){
  if(!nowUser)return;
  const d=db();
  const list=d.users.filter(u=>u.user!==nowUser);
  let html="";
  list.forEach(u=>{
    const mut=isMutual(u.user);
    html+=`
    <div class="chat-item" onclick="${mut?'openChat(`'+u.user+'`)':'follow(`'+u.user+'`)'}">
      ${u.user} ${mut?'(äº’å…³å¯ç§èŠ)':'(ç‚¹å‡»å…³æ³¨)'}
    </div>`;
  });
  document.getElementById("followList").innerHTML=html;
}
function openChat(user){
  chatTarget=user;
  document.getElementById("chatTo").innerText="å’Œ "+user+" èŠå¤©";
  document.getElementById("chatBox").style.display="block";
  renderMsg();
}
function sendMsg(){
  if(!chatTarget||!nowUser)return;
  const txt=document.getElementById("msgInput").value.trim();
  if(!txt)return;
  const d=db();
  const key=[nowUser,chatTarget].sort().join("_");
  if(!d.chats[key])d.chats[key]=[];
  d.chats[key].push({from:nowUser,to:chatTarget,msg:txt,time:new Date().toLocaleString()});
  save(d);
  document.getElementById("msgInput").value="";
  renderMsg();
}
function renderMsg(){
  const d=db();
  const key=[nowUser,chatTarget].sort().join("_");
  const list=d.chats[key]||[];
  let html="";
  list.forEach(m=>{
    html+=`<div class="${m.from===nowUser?'msg-me':'msg-you'}">${m.msg}</div>`;
  });
  document.getElementById("msgBox").innerHTML=html;
  document.getElementById("msgBox").scrollTop=9999;
}

// ================= é€€å‡º =================
function logout(){
  nowUser=null;
  localStorage.removeItem("nowUser");
  renderUser();
}

// ================= æ¸²æŸ“ä¸ªäººä¸­å¿ƒ =================
function renderUser(){
  if(nowUser){
    document.getElementById("loginCard").style.display="none";
    document.getElementById("regCard").style.display="none";
    document.getElementById("userInfo").style.display="block";
    const d=db();
    const u=d.users.find(x=>x.user===nowUser);
    document.getElementById("infoDisplay").innerHTML=`
      <div class="info-item">ç”¨æˆ·ï¼š${u.user}</div>
      <div class="info-item">å¾®ä¿¡ï¼š${u.wechat||'æœªå¡«'}</div>
      <div class="info-item">é‚®ç®±ï¼š${u.email}</div>`;
    document.getElementById("adminPanel").style.display=nowUser===ADMIN_USER?"block":"none";
    renderWait();
  }else{
    document.getElementById("loginCard").style.display="block";
    document.getElementById("regCard").style.display="block";
    document.getElementById("userInfo").style.display="none";
  }
}

// ================= æŠ•ç¨¿ =================
function publish(){
  if(!nowUser){alert("è¯·å…ˆç™»å½•");goPage("user");return;}
  const c=document.getElementById("content").value.trim();
  if(!c)return;
  const d=db();
  d.wait.push({user:nowUser,content:c,time:new Date().toLocaleString()});
  save(d);
  document.getElementById("content").value="";
  alert("å·²æäº¤å®¡æ ¸");
}
function renderWait(){
  const d=db();
  let html="";
  d.wait.forEach((it,i)=>{
    html+=`
    <div class="wait-item">
      <div>${it.user}</div><div>${it.content}</div>
      <button class="btn sm success" onclick="pass(${i})">é€šè¿‡</button>
      <button class="btn sm danger" onclick="delWait(${i})">åˆ é™¤</button>
    </div>`;
  });
  document.getElementById("waitPosts").innerHTML=html;
  renderHome();
}
function pass(i){
  const d=db();
  d.posts.unshift(d.wait.splice(i,1)[0]);
  save(d);
  renderWait();
}
function delWait(i){
  const d=db();
  d.wait.splice(i,1);
  save(d);
  renderWait();
}
function renderHome(){
  const d=db();
  let html="";
  d.posts.forEach(p=>{
    html+=`<div class="post"><div class="user">${p.user}</div>
    <div class="content">${p.content}</div><div class="time">${p.time}</div></div>`;
  });
  document.getElementById("postList").innerHTML=html||"<div>æš‚æ— æŠ•ç¨¿</div>";
}

// ================= å¯åŠ¨ =================
window.onload=function(){
  showNotice();
  renderHome();
  renderUser();
};
</script>
</body>
</html>
